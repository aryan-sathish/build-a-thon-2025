<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <title>H2Optimize</title>
   {% include 'design_templates/head.html' %}
   <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
   <h1 id    = "TITLE">H2Optimize</h1>
   {% include 'design_templates/header.html' %}
   <!-- {% include 'design_templates/header.html' %} -->
    <div class="rain"></div>
    <main>
   <h2>Measure Your Water Usage!</h2>
   <!-- <form action="/" method="POST">
      Test
   </form> -->
   
   <button class="water-btn" title="Start Timer" id="btn-timer">
      <i class="bi bi-droplet-fill"></i>
   </button>

<div id="flow-popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
   background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.3); text-align:center;">
  <h3>How much water does your shower use?</h3>
  <button class="flow-btn" data-flow="3">A lot (3 gpm)</button>
  <button class="flow-btn" data-flow="2.5">Medium (2.5 gpm)</button>
  <button class="flow-btn" data-flow="2">A little (2 gpm)</button>
</div>

   <button type="button" class="btn stop-btn" aria-label="Stop" id="btn-stop" style="background-color:red; color:white;">
  Stop Timer
</button>

   <h1 id="timer">00:00:00</h1>

   <h3 id="Report"></h3>
   <script> 
      let selectedFlowRate = 0;
      let seconds = 0;
      let minutes = 0;
      let hours = 0;
      // let timer = 0;
      let interval = null;

      window.addEventListener("load", () => {
   const prev = localStorage.getItem("lastUsage");
   if (prev) {
      document.getElementById("Report").textContent =
         "Last shower: " + parseFloat(prev).toFixed(2) + " gallons.";} else {
      report.textContent = "No previous data â€” start tracking now!";
   }
});


     const popup = document.getElementById("flow-popup");
         const timerDisplay = document.getElementById("timer");

         function updateTimerDisplay() {
            const formattedTime =
               String(hours).padStart(2, '0') + ":" +
               String(minutes).padStart(2, '0') + ":" +
               String(seconds).padStart(2, '0');
            timerDisplay.textContent = formattedTime;
         }

         // Show popup when Start Timer is clicked
         document.getElementById("btn-timer").addEventListener("click", function() {
            popup.style.display = "block";
         });

         // When user selects flow rate
         document.querySelectorAll(".flow-btn").forEach(btn => {
            btn.addEventListener("click", function() {
               selectedFlowRate = parseFloat(this.dataset.flow);
               console.log("Selected flow rate:", selectedFlowRate, "gpm");
               popup.style.display = "none";

               // Reset and start timer
               clearInterval(interval);
               seconds = 0; 
               minutes = 0; 
               hours = 0;
               // timer = 0;
               updateTimerDisplay();

               interval = setInterval(() => {
                  seconds++;
                  // timer++;
                  if (seconds == 60) {
                     seconds = 0;
                     minutes++;
                     // timer++;
                  }
                  if (minutes == 60) {
                     minutes = 0;
                     hours++;
                     // timer++;
                  }
                  updateTimerDisplay();

                  let totalMinutes = hours * 60 + minutes + seconds / 60;
                  let gallons_used = totalMinutes * selectedFlowRate;
                  document.getElementById("Report").textContent = "Gallons used so far: " + gallons_used.toFixed(2);


               }, 1000);
            });
         });

         // Stop button
         document.getElementById("btn-stop").addEventListener("click", function() {
            clearInterval(interval);
            interval = null;
            console.log("Timer stopped at:", timerDisplay.textContent);

            let totalMinutes = hours * 60 + minutes + seconds / 60;


            // Water Used = duration of shower * flow rate

            //Gallons Used
            let gallons_used = totalMinutes * selectedFlowRate;
            let gallons_used_report = ("You used " + gallons_used.toFixed(2) + " gallons of water!");
            document.getElementById("Report").innerHTML = gallons_used_report;


            //Store previous usages for later reference
            let previousUsage = localStorage.getItem("lastUsage");
            console.log("Previous usage found:", previousUsage);
            if (previousUsage) {
               document.getElementById("Report").textContent += "\nLast shower: " + parseFloat(previousUsage).toFixed(2) + " gallons.";
            }        
            localStorage.setItem("lastUsage", gallons_used);
            

            //Report how they did.
            if (gallons_used < 10) {
               document.getElementById("Report").innerHTML += " âœ¨ðŸ¤© WOW! You're a water saving legend!";
               document.getElementById("Report").style.color = "gold";
            } 
            else if (gallons_used < 15) {
               document.getElementById("Report").innerHTML += " ðŸ† Great job saving water!";
               document.getElementById("Report").style.color = "aqua";
            }
            else if (gallons_used < 20) {
               document.getElementById("Report").innerHTML += " ðŸ‘ Nice job! You're getting better!";
               document.getElementById("Report").style.color = "aquamarine";
            }  else if (gallons_used < 30) {
               document.getElementById("Report").innerHTML += " ðŸ’§ Not bad, but you can do better!";
               document.getElementById("Report").style.color = "blue";
            } else if (gallons_used < 35) {
               document.getElementById("Report").innerHTML += " ðŸš¿ Try to shorten your showers!";
               document.getElementById("Report").style.color = "salmon";
            } else {
               document.getElementById("Report").innerHTML += " ðŸ˜¡ DANG! No wonder why there are so many droughts! ";
               document.getElementById("Report").style.color = "crimson";
            }
            if (previousUsage) {
        reportText += "\nLast shower: " + parseFloat(previousUsage).toFixed(2) + " gallons.";
    }

    // Update report
    document.getElementById("Report").textContent = reportText;

    // Save current usage for next time
    localStorage.setItem("lastUsage", gallons_used);
         });

          const rainContainer = document.querySelector(".rain");
    const numberOfDrops = 120; // increase for heavier rain

    for (let i = 0; i < numberOfDrops; i++) {
        const drop = document.createElement("div");
        drop.classList.add("rain-drop");

        // Random horizontal position across viewport
        drop.style.left = Math.random() * 100 + "vw";

        // Random animation duration (speed)
        const duration = Math.random() * 2 + 2; // 2-4 seconds
        drop.style.animationDuration = duration + "s";

        // Random animation delay (start time)
        drop.style.animationDelay = Math.random() * 5 + "s";

        // Random width and height for natural variation
        const scale = Math.random() * 1 + 0.5;
        drop.style.width = 2 * scale + "px";
        drop.style.height = 10 * scale + "px";

        rainContainer.appendChild(drop);
    }

   </script>
   </main>
   
   {% include 'design_templates/footer.html' %}
</body>
</html>